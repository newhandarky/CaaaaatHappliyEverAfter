import{a as m,_ as h}from"./config-82256151.js";import"./admin_header-36cd02a6.js";import{S as b}from"./sweetalert2.all-bdf3eb51.js";import{h as S}from"./moment-fbc5633a.js";import{h as p}from"./admin_config-2cf1d757.js";const w=document.querySelector(".bookingId"),Z=document.querySelector(".memberName"),D=document.querySelector(".bookingState"),v=document.querySelector(".checkIn"),q=document.querySelector(".checkOut"),j=document.querySelector(".memberPhone"),y=document.querySelector(".bookingRoomType"),d=document.querySelector(".bookingDays"),G=document.querySelector(".checkInCats"),J=document.querySelector(".plusCatPay"),C=document.querySelector(".totalPrice"),K=document.querySelector(".getCats"),Y=document.querySelector(".remark"),Q=document.querySelector(".tbody"),x=document.querySelector(".btnUpdate"),R=document.querySelector(".btnUpdateCancel"),U=document.querySelector(".btnSave"),B=document.querySelector(".btnCancel"),F=document.querySelector(".btnBack"),V=document.querySelector("form");let W;const X=m.get(`${h}/660/bookings/${localStorage.getItem("bookingNum")}`,p),tt=m.get(`${h}/660/rooms/`,p),et=m.get(`${h}/660/roomstates/`,p),ot=m.get(`${h}/660/cats`,p);Promise.all([X,tt,et,ot]).then(function(t){const e=t[0].data,n=t[1].data,u=t[2].data,c=t[3].data,r=m.get(`${h}/660/users/${e.userId}`,p).then(function(o){return E(e,n,o.data),o.data}).catch(function(o){console.log(o)});let s=[];c.forEach(function(o){o.userId==e.userId&&s.push(o)});let i="";s.forEach(function(o,a){i+=`<div class="col-4">
                    <div class="form-check">
                        <input class="form-check-input" data-catid="${o.id}" type="checkbox" id="memberCat${a+1}">
                        <label class="form-check-label memberCat${a+1}" for="memberCat${a+1}">${o.catName}</label>
                    </div>
                </div>`,K.innerHTML=i}),_(),e.cats.forEach(function(o){document.querySelectorAll(".form-check-input").forEach(function(a){parseInt(a.dataset.catid)===o&&a.setAttribute("checked",!0)})}),(e.state==="已取消"||e.state==="已退房")&&x.setAttribute("disabled",!0),U.addEventListener("click",function(){let o=[];u.forEach(function(l){o.push(l)});let a=[];A(a,o);const g={經典房:"classic",精緻房:"delicate",豪華房:"luxury"};let $=1;for(let l=1;l<=d.value;l++)o.forEach(function(k){k.date===S(v.value).add(l-1,"day").format("YYYY-MM-DD")&&($*=k.availableCount[g[y.value]])});if($>0){for(let f=1;f<=d.value;f++)o.forEach(function(I){I.date===S(v.value).add(f-1,"day").format("YYYY-MM-DD")&&(I.availableCount[g[y.value]]--,a.push(I))});a.forEach(function(f){m.patch(`${h}/660/roomStates/${f.id}`,f,{headers:{authorization:`Bearer ${localStorage.getItem("userLoginToken")}`}}).then(function(I){}).catch(function(I){console.log(I.response)})});const l={};H(l,D.value),N(l);const k={經典房:51,精緻房:52,豪華房:53};e.checkIn=v.value,e.checkOut=q.value,e.remark=Y.value,e.quantity=d.value,e.price=C.value,e.state=D.value,e.roomId=k[y.value],e.admin.userId=localStorage.getItem("userId"),e.cats=[],document.querySelectorAll(".form-check-input").forEach(function(f){f.checked&&e.cats.push(parseInt(f.dataset.catid))}),L(e),E(e,n,r),T()}else a=[],T(),rt(),E(e,n,r)}),B.addEventListener("click",function(){b.fire({title:"確定要取消此訂單嗎?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"確定取消",cancelButtonText:"返回訂單"}).then(o=>{o.isConfirmed&&m.patch(`${h}/660/bookings/${localStorage.getItem("bookingNum")}`,{state:"已取消"},p).then(function(a){const g={};H(g,"已取消"),E(e,n,r),T();let $=[];A($,u),$.forEach(function(l){u.forEach(function(k){l.date===k.date&&m.patch(`${h}/660/roomStates/${l.id}`,l,p).then(function(f){N(g),b.mixin({toast:!0,position:"center",showConfirmButton:!1,timer:1200,timerProgressBar:!0,didOpen:M=>{M.onmouseenter=b.stopTimer,M.onmouseleave=b.resumeTimer}}).fire({icon:"success",title:"訂單已取消成功"})}).catch(function(f){console.log(f.response)})})})}).catch(function(a){console.log(a)})})});function A(o,a){let g=e.checkIn;const $={51:"classic",52:"delicate",53:"luxury"};for(let l=0;l<e.quantity;l++)a.forEach(function(k){k.date===S(g).add(0+l,"day").format("YYYY-MM-DD")&&(k.availableCount[$[e.roomId]]++,o.push(k))})}function L(o){m.patch(`${h}/660/bookings/${o.id}`,o,p).then(function(a){E(a.data,n,r)}).catch(function(a){console.log(a)})}function z(o){m.get(`${h}/660/bookings/${o.bookingsId}`,p).then(function(a){const g=a.data;g.history.push(o.id),L(g)}).catch(function(a){console.log(a)})}function N(o){m.post(`${h}/660/bookingHistorys`,o,p).then(function(a){z(a.data)}).catch(function(a){console.log(a)})}}).catch(function(t){console.log(t)});function at(t){let e=[],n="";function u(r){return m.get(`${h}/660/bookingHistorys/${r}`,p).then(s=>{const i={};i.updateTime=s.data.updateTime,i.catNum=s.data.catNum,i.admin=s.data.admin,i.checkIn=s.data.checkIn,i.checkOut=s.data.checkOut,i.quantity=s.data.quantity,i.roomType=s.data.roomType,i.state=s.data.state,i.price=s.data.price,i.remark=s.data.remark,e.push(i)}).catch(s=>{console.error(s)})}const c=t.map(r=>u(r));return Promise.all(c).then(()=>{e.forEach(function(r){n+=`<tr>
                            <th class="text-nowrap p-1" scope="row">${r.updateTime}</th>
                            <td class="text-nowrap p-1">${r.state}</td>
                            <td class="text-nowrap p-1">${r.checkIn}</td>
                            <td class="text-nowrap p-1">${r.checkOut}</td>
                            <td class="text-nowrap p-1">${r.quantity}</td>
                            <td class="text-nowrap p-1">${r.roomType}</td>
                            <td class="text-nowrap p-1">${r.price}</td>
                            <td class="text-nowrap p-1">${r.catNum}</td>
                            <td class="text-nowrap p-1">${r.remark}</td>
                            <td class="text-nowrap p-1">${r.admin}</td>
                        </tr>`}),Q.innerHTML=n})}function E(t,e,n){let u="";e.forEach(function(c){c.id===t.roomId&&(u=c.name)}),at(t.history),w.value=localStorage.getItem("bookingNum"),Z.value=n.name,D.value=t.state,v.value=t.checkIn,q.value=t.checkOut,j.value=n.phone,y.value=u,d.value=t.quantity,Y.value=t.remark,G.value=t.cats.length,J.value=(t.cats.length-1)*300*t.quantity,e.forEach(function(c){c.id===t.roomId&&(C.value=c.price*t.quantity+(t.cats.length-1)*300*t.quantity)})}function T(){F.classList.toggle("d-none"),U.classList.toggle("d-none"),x.classList.toggle("d-none"),R.classList.toggle("d-none")}function _(){D.toggleAttribute("disabled"),v.toggleAttribute("disabled"),q.toggleAttribute("disabled"),y.toggleAttribute("disabled"),d.toggleAttribute("disabled"),Y.toggleAttribute("disabled"),B.toggleAttribute("disabled"),document.querySelectorAll(".form-check-input").forEach(function(t){t.toggleAttribute("disabled")})}function P(){b.fire({title:"日期格式錯誤?",text:"入住日期不可與退房日期相等, 或在其之後",icon:"error"})}function ct(){b.fire({icon:"warning",title:"系統提示",text:"資料有修改且尚未儲存, 確定取消修改資料嗎?"})}function O(t){let e=0;return t.forEach(function(n){n.checked&&e++}),e}function nt(){const t=document.querySelectorAll(".form-check-input");let e=O(t);return e<=0&&b.fire({icon:"error",title:"入住貓咪數量不能小於 1"}),O(t),e}function H(t,e){let n=0;document.querySelectorAll(".form-check-input").forEach(function(u){u.checked&&n++}),t.state=e,t.catNum=n,t.updateTime=S().format("YYYY-MM-DD hh-mm-ss a"),t.checkIn=v.value,t.checkOut=q.value,t.quantity=d.value,t.roomType=y.value,t.bookingsId=w.value,t.price=C.value,t.remark=Y.value,t.admin=localStorage.getItem("userName")}function rt(){b.fire({icon:"error",title:"很抱歉",text:"您選擇的日期與房型目前已滿房"})}V.addEventListener("change",function(t){const e=S(v.value),u=S(q.value).diff(e,"days");t.target.classList.contains("bookingDays")&&(d.value<=0?P():q.value=S(v.value).add(d.value,"days").format("YYYY-MM-DD"),roomObj.forEach(function(c){c.name===y.value&&(C.value=c.price*d.value)})),t.target.classList.contains("checkIn")&&(q.value=S(v.value).add(d.value,"days").format("YYYY-MM-DD")),t.target.classList.contains("checkOut")&&(u<=0?P():d.value=u,roomObj.forEach(function(c){c.name===y.value&&(C.value=c.price*d.value)})),t.target.classList.contains("bookingRoomType")&&roomObj.forEach(function(c){c.name===y.value&&(C.value=c.price*d.value)}),nt()});document.querySelectorAll("a").forEach(function(t){t.addEventListener("click",function(e){const n={經典房:51,精緻房:52,豪華房:53};let u="";if(document.querySelectorAll(".form-check-input").forEach(function(c){c.checked&&(u+=c.dataset.catid)}),D.value!=="已取消"&&(bookingObj.checkIn!==v.value||bookingObj.checkOut!==q.value||bookingObj.state!==D.value||bookingObj.remark!==Y.value||bookingObj.roomId!==n[y.value]||bookingObj.cats.join(",")!==u))return e.preventDefault(),ct()})});x.addEventListener("click",function(){T(),_()});R.addEventListener("click",function(){T(),E(bookingObj,roomObj,W)});F.addEventListener("click",function(){location="admin_bookingList.html"});
