import{a as m,_ as h,S as I}from"./sweetalert2.all-203b6da2.js";import{h as b}from"./admin_header-cdcf5a9d.js";import{h as p}from"./admin_config-2cf1d757.js";import{r as S}from"./loginIsTimeUp-b8b3d4c8.js";const B=document.querySelector(".bookingId"),J=document.querySelector(".memberName"),x=document.querySelector(".bookingState"),y=document.querySelector(".checkIn"),C=document.querySelector(".checkOut"),K=document.querySelector(".memberPhone"),k=document.querySelector(".bookingRoomType"),d=document.querySelector(".bookingDays"),Q=document.querySelector(".checkInCats"),V=document.querySelector(".plusCatPay"),Y=document.querySelector(".totalPrice"),W=document.querySelector(".getCats"),L=document.querySelector(".remark"),X=document.querySelector(".tbody"),A=document.querySelector(".btnUpdate"),_=document.querySelector(".btnUpdateCancel"),F=document.querySelector(".btnSave"),z=document.querySelector(".btnCancel"),Z=document.querySelector(".btnBack"),O=document.querySelector("form"),j=m.get(`${h}/660/bookings/${localStorage.getItem("bookingNum")}`,p),tt=m.get(`${h}/660/rooms/`,p),et=m.get(`${h}/660/roomstates/`,p),ot=m.get(`${h}/660/cats`,p),at=m.get(`${h}/660/users/${localStorage.getItem("bookingUserId")}`,p);Promise.all([j,tt,et,ot,at]).then(function(t){const e=t[0].data,n=t[1].data,l=t[2].data,r=t[3].data,c=t[4].data;E(e,n,c);let u=[];r.forEach(function(a){a.userId==e.userId&&u.push(a)});let i="";u.forEach(function(a,o){i+=`<div class="col-4">
                    <div class="form-check">
                        <input class="form-check-input" data-catid="${a.id}" type="checkbox" id="memberCat${o+1}">
                        <label class="form-check-label memberCat${o+1}" for="memberCat${o+1}">${a.catName}</label>
                    </div>
                </div>`,W.innerHTML=i}),D(),e.cats.forEach(function(a){document.querySelectorAll(".form-check-input").forEach(function(o){parseInt(o.dataset.catid)===a&&o.setAttribute("checked",!0)})}),F.addEventListener("click",function(){let a=[];l.forEach(function(s){a.push(s)});let o=[];M(o,a);const g={經典房:"classic",精緻房:"delicate",豪華房:"luxury"};let $=1;for(let s=1;s<=d.value;s++)a.forEach(function(v){v.date===b(y.value).add(s-1,"day").format("YYYY-MM-DD")&&($*=v.availableCount[g[k.value]])});if($>0){for(let f=1;f<=d.value;f++)a.forEach(function(q){q.date===b(y.value).add(f-1,"day").format("YYYY-MM-DD")&&(q.availableCount[g[k.value]]--,o.push(q))});o.forEach(function(f){m.patch(`${h}/660/roomStates/${f.id}`,f,{headers:{authorization:`Bearer ${localStorage.getItem("userLoginToken")}`}}).then(function(q){}).catch(function(q){S(q.response.data)})});const s={};w(s,x.value),P(s);const v={經典房:51,精緻房:52,豪華房:53};e.checkIn=y.value,e.checkOut=C.value,e.remark=L.value,e.quantity=d.value,e.price=Y.value,e.state=x.value,e.roomId=v[k.value],e.admin.userId=localStorage.getItem("userId"),e.cats=[],document.querySelectorAll(".form-check-input").forEach(function(f){f.checked&&e.cats.push(parseInt(f.dataset.catid))}),N(e),E(e,n,c),T(),D()}else o=[],T(),rt(),E(e,n,c),D()}),z.addEventListener("click",function(){I.fire({title:"確定要取消此訂單嗎?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"確定取消",cancelButtonText:"返回訂單"}).then(a=>{a.isConfirmed&&m.patch(`${h}/660/bookings/${localStorage.getItem("bookingNum")}`,{state:"已取消"},p).then(function(o){const g={};w(g,"已取消"),E(e,n,c),T(),D();let $=[];M($,l),$.forEach(function(s){l.forEach(function(v){s.date===v.date&&m.patch(`${h}/660/roomStates/${s.id}`,s,p).then(function(f){P(g),I.mixin({toast:!0,position:"center",showConfirmButton:!1,timer:1200,timerProgressBar:!0,didOpen:H=>{H.onmouseenter=I.stopTimer,H.onmouseleave=I.resumeTimer}}).fire({icon:"success",title:"訂單已取消成功"})}).catch(function(f){S(f.response.data)})})})}).catch(function(o){S(o.response.data)})})});function M(a,o){let g=e.checkIn;const $={51:"classic",52:"delicate",53:"luxury"};for(let s=0;s<e.quantity;s++)o.forEach(function(v){v.date===b(g).add(0+s,"day").format("YYYY-MM-DD")&&(v.availableCount[$[e.roomId]]++,a.push(v))})}function N(a){m.patch(`${h}/660/bookings/${a.id}`,a,p).then(function(o){E(o.data,n,c)}).catch(function(o){S(o.response.data)})}function G(a){m.get(`${h}/660/bookings/${a.bookingsId}`,p).then(function(o){const g=o.data;g.history.push(a.id),N(g)}).catch(function(o){S(o.response.data)})}function P(a){m.post(`${h}/660/bookingHistorys`,a,p).then(function(o){G(o.data)}).catch(function(o){S(o.response.data)})}A.addEventListener("click",function(){T(),D()}),_.addEventListener("click",function(){T(),D(),E(e,n,c)})}).catch(function(t){S(t.response.data)});function ct(t){let e=[],n="";function l(c){return m.get(`${h}/660/bookingHistorys/${c}`,p).then(u=>{const i={};i.updateTime=u.data.updateTime,i.catNum=u.data.catNum,i.admin=u.data.admin,i.checkIn=u.data.checkIn,i.checkOut=u.data.checkOut,i.quantity=u.data.quantity,i.roomType=u.data.roomType,i.state=u.data.state,i.price=u.data.price,i.remark=u.data.remark,e.push(i)}).catch(u=>{console.error(u),S(u.response.data)})}const r=t.map(c=>l(c));return Promise.all(r).then(()=>{e.forEach(function(c){n+=`<tr>
                            <th class="text-nowrap p-1" scope="row">${c.updateTime}</th>
                            <td class="text-nowrap p-1">${c.state}</td>
                            <td class="text-nowrap p-1">${c.checkIn}</td>
                            <td class="text-nowrap p-1">${c.checkOut}</td>
                            <td class="text-nowrap p-1">${c.quantity}</td>
                            <td class="text-nowrap p-1">${c.roomType}</td>
                            <td class="text-nowrap p-1">${c.price}</td>
                            <td class="text-nowrap p-1">${c.catNum}</td>
                            <td class="text-nowrap p-1">${c.remark}</td>
                            <td class="text-nowrap p-1">${c.admin}</td>
                        </tr>`}),X.innerHTML=n})}function E(t,e,n){let l="";e.forEach(function(r){r.id===t.roomId&&(l=r.name)}),ct(t.history),B.value=localStorage.getItem("bookingNum"),J.value=n.name,x.value=t.state,y.value=t.checkIn,C.value=t.checkOut,K.value=n.phone,k.value=l,d.value=t.quantity,L.value=t.remark,Q.value=t.cats.length,V.value=(t.cats.length-1)*300*t.quantity,e.forEach(function(r){r.id===t.roomId&&(Y.value=r.price*t.quantity+(t.cats.length-1)*300*t.quantity)}),(t.state==="已取消"||t.state==="已退房")&&A.setAttribute("disabled",!0)}function T(){Z.classList.toggle("d-none"),F.classList.toggle("d-none"),A.classList.toggle("d-none"),_.classList.toggle("d-none")}function D(){x.toggleAttribute("disabled"),y.toggleAttribute("disabled"),C.toggleAttribute("disabled"),k.toggleAttribute("disabled"),d.toggleAttribute("disabled"),L.toggleAttribute("disabled"),z.toggleAttribute("disabled"),document.querySelectorAll(".form-check-input").forEach(function(t){t.toggleAttribute("disabled")})}function R(){I.fire({title:"日期格式錯誤?",text:"入住日期不可與退房日期相等, 或在其之後",icon:"error"})}function U(t){let e=0;return t.forEach(function(n){n.checked&&e++}),e}function nt(){const t=document.querySelectorAll(".form-check-input");let e=U(t);return e<=0&&I.fire({icon:"error",title:"入住貓咪數量不能小於 1"}),U(t),e}function w(t,e){let n=0;document.querySelectorAll(".form-check-input").forEach(function(l){l.checked&&n++}),t.state=e,t.catNum=n,t.updateTime=b().format("YYYY-MM-DD hh-mm-ss a"),t.checkIn=y.value,t.checkOut=C.value,t.quantity=d.value,t.roomType=k.value,t.bookingsId=B.value,t.price=Y.value,t.remark=L.value,t.admin=localStorage.getItem("userName")}function rt(){I.fire({icon:"error",title:"很抱歉",text:"您選擇的日期與房型目前已滿房"})}O.addEventListener("change",function(t){const e=b(y.value),l=b(C.value).diff(e,"days");t.target.classList.contains("bookingDays")&&(d.value<=0?R():C.value=b(y.value).add(d.value,"days").format("YYYY-MM-DD"),roomObj.forEach(function(r){r.name===k.value&&(Y.value=r.price*d.value)})),t.target.classList.contains("checkIn")&&(C.value=b(y.value).add(d.value,"days").format("YYYY-MM-DD")),t.target.classList.contains("checkOut")&&(l<=0?R():d.value=l,roomObj.forEach(function(r){r.name===k.value&&(Y.value=r.price*d.value)})),t.target.classList.contains("bookingRoomType")&&roomObj.forEach(function(r){r.name===k.value&&(Y.value=r.price*d.value)}),nt()});Z.addEventListener("click",function(){location="admin_bookingList.html"});
