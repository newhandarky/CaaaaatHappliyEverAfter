import"./bootstrap.min-47e23b13.js";import"./admin_header-568a311b.js";import{a as f,_ as m}from"./config-4096d6dc.js";import{S as g}from"./sweetalert2.all-9c5228de.js";import{h as S}from"./moment-fbc5633a.js";import{h as p}from"./admin_config-2cf1d757.js";function T(t){const e={};t==="jwt expired"&&g.fire({title:"您的帳號登入已逾時, 請重新登入",input:"email",inputLabel:"您的帳號",inputPlaceholder:"Enter your email address"}).then(({value:a})=>(e.email=a,g.fire({title:"請輸入您的密碼",input:"password",inputLabel:"Password",inputPlaceholder:"Enter your password",inputAttributes:{maxlength:"20",autocapitalize:"off",autocorrect:"off"}}))).then(({value:a})=>{e.password=a,G(e)})}function G(t){f.post(`${m}/login`,t).then(function(e){console.log(e),e.data.user.role==="admin"?(console.log(e.data),localStorage.setItem("userRole",e.data.user.role),localStorage.setItem("userName",e.data.user.name),localStorage.setItem("userLoginToken",e.data.accessToken),location.reload()):(console.log("非管理員"),g.fire({title:"你是誰?",text:"你怎麼會來這裡?",icon:"info",confirmButtonColor:"#3085d6"}).then(a=>{a.isConfirmed&&(location="index.html")}))}).catch(function(e){console.log(e.response)})}const B=document.querySelector(".bookingId"),J=document.querySelector(".memberName"),x=document.querySelector(".bookingState"),y=document.querySelector(".checkIn"),I=document.querySelector(".checkOut"),K=document.querySelector(".memberPhone"),b=document.querySelector(".bookingRoomType"),d=document.querySelector(".bookingDays"),Q=document.querySelector(".checkInCats"),V=document.querySelector(".plusCatPay"),D=document.querySelector(".totalPrice"),W=document.querySelector(".getCats"),L=document.querySelector(".remark"),X=document.querySelector(".tbody"),A=document.querySelector(".btnUpdate"),O=document.querySelector(".btnUpdateCancel"),F=document.querySelector(".btnSave"),_=document.querySelector(".btnCancel"),z=document.querySelector(".btnBack"),j=document.querySelector("form"),tt=f.get(`${m}/660/bookings/${localStorage.getItem("bookingNum")}`,p),et=f.get(`${m}/660/rooms/`,p),ot=f.get(`${m}/660/roomstates/`,p),at=f.get(`${m}/660/cats`,p),ct=f.get(`${m}/660/users/${localStorage.getItem("bookingUserId")}`,p);Promise.all([tt,et,ot,at,ct]).then(function(t){const e=t[0].data,a=t[1].data,u=t[2].data,n=t[3].data,r=t[4].data;E(e,a,r);let l=[];n.forEach(function(c){c.userId==e.userId&&l.push(c)});let i="";l.forEach(function(c,o){i+=`<div class="col-4">
                    <div class="form-check">
                        <input class="form-check-input" data-catid="${c.id}" type="checkbox" id="memberCat${o+1}">
                        <label class="form-check-label memberCat${o+1}" for="memberCat${o+1}">${c.catName}</label>
                    </div>
                </div>`,W.innerHTML=i}),C(),e.cats.forEach(function(c){document.querySelectorAll(".form-check-input").forEach(function(o){parseInt(o.dataset.catid)===c&&o.setAttribute("checked",!0)})}),F.addEventListener("click",function(){let c=[];u.forEach(function(s){c.push(s)});let o=[];P(o,c);const v={經典房:"classic",精緻房:"delicate",豪華房:"luxury"};let q=1;for(let s=1;s<=d.value;s++)c.forEach(function(k){k.date===S(y.value).add(s-1,"day").format("YYYY-MM-DD")&&(q*=k.availableCount[v[b.value]])});if(q>0){for(let h=1;h<=d.value;h++)c.forEach(function($){$.date===S(y.value).add(h-1,"day").format("YYYY-MM-DD")&&($.availableCount[v[b.value]]--,o.push($))});o.forEach(function(h){f.patch(`${m}/660/roomStates/${h.id}`,h,{headers:{authorization:`Bearer ${localStorage.getItem("userLoginToken")}`}}).then(function($){}).catch(function($){console.log($.response)})});const s={};U(s,x.value),M(s);const k={經典房:51,精緻房:52,豪華房:53};e.checkIn=y.value,e.checkOut=I.value,e.remark=L.value,e.quantity=d.value,e.price=D.value,e.state=x.value,e.roomId=k[b.value],e.admin.userId=localStorage.getItem("userId"),e.cats=[],document.querySelectorAll(".form-check-input").forEach(function(h){h.checked&&e.cats.push(parseInt(h.dataset.catid))}),N(e),E(e,a,r),Y(),C()}else o=[],Y(),lt(),E(e,a,r),C()}),_.addEventListener("click",function(){g.fire({title:"確定要取消此訂單嗎?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"確定取消",cancelButtonText:"返回訂單"}).then(c=>{c.isConfirmed&&f.patch(`${m}/660/bookings/${localStorage.getItem("bookingNum")}`,{state:"已取消"},p).then(function(o){const v={};U(v,"已取消"),E(e,a,r),Y(),C();let q=[];P(q,u),q.forEach(function(s){u.forEach(function(k){s.date===k.date&&f.patch(`${m}/660/roomStates/${s.id}`,s,p).then(function(h){M(v),g.mixin({toast:!0,position:"center",showConfirmButton:!1,timer:1200,timerProgressBar:!0,didOpen:w=>{w.onmouseenter=g.stopTimer,w.onmouseleave=g.resumeTimer}}).fire({icon:"success",title:"訂單已取消成功"})}).catch(function(h){console.log(h.response)})})})}).catch(function(o){console.log(o),T(o.response.data)})})});function P(c,o){let v=e.checkIn;const q={51:"classic",52:"delicate",53:"luxury"};for(let s=0;s<e.quantity;s++)o.forEach(function(k){k.date===S(v).add(0+s,"day").format("YYYY-MM-DD")&&(k.availableCount[q[e.roomId]]++,c.push(k))})}function N(c){f.patch(`${m}/660/bookings/${c.id}`,c,p).then(function(o){E(o.data,a,r)}).catch(function(o){console.log(o),T(o.response.data)})}function Z(c){f.get(`${m}/660/bookings/${c.bookingsId}`,p).then(function(o){const v=o.data;v.history.push(c.id),N(v)}).catch(function(o){console.log(o),T(o.response.data)})}function M(c){f.post(`${m}/660/bookingHistorys`,c,p).then(function(o){Z(o.data)}).catch(function(o){console.log(o),T(o.response.data)})}A.addEventListener("click",function(){Y(),C()}),O.addEventListener("click",function(){Y(),C(),E(e,a,r)})}).catch(function(t){console.log(t),T(t.response.data)});function nt(t){let e=[],a="";function u(r){return f.get(`${m}/660/bookingHistorys/${r}`,p).then(l=>{const i={};i.updateTime=l.data.updateTime,i.catNum=l.data.catNum,i.admin=l.data.admin,i.checkIn=l.data.checkIn,i.checkOut=l.data.checkOut,i.quantity=l.data.quantity,i.roomType=l.data.roomType,i.state=l.data.state,i.price=l.data.price,i.remark=l.data.remark,e.push(i)}).catch(l=>{console.error(l),T(l.response.data)})}const n=t.map(r=>u(r));return Promise.all(n).then(()=>{e.forEach(function(r){a+=`<tr>
                            <th class="text-nowrap p-1" scope="row">${r.updateTime}</th>
                            <td class="text-nowrap p-1">${r.state}</td>
                            <td class="text-nowrap p-1">${r.checkIn}</td>
                            <td class="text-nowrap p-1">${r.checkOut}</td>
                            <td class="text-nowrap p-1">${r.quantity}</td>
                            <td class="text-nowrap p-1">${r.roomType}</td>
                            <td class="text-nowrap p-1">${r.price}</td>
                            <td class="text-nowrap p-1">${r.catNum}</td>
                            <td class="text-nowrap p-1">${r.remark}</td>
                            <td class="text-nowrap p-1">${r.admin}</td>
                        </tr>`}),X.innerHTML=a})}function E(t,e,a){let u="";e.forEach(function(n){n.id===t.roomId&&(u=n.name)}),nt(t.history),B.value=localStorage.getItem("bookingNum"),J.value=a.name,x.value=t.state,y.value=t.checkIn,I.value=t.checkOut,K.value=a.phone,b.value=u,d.value=t.quantity,L.value=t.remark,Q.value=t.cats.length,V.value=(t.cats.length-1)*300*t.quantity,e.forEach(function(n){n.id===t.roomId&&(D.value=n.price*t.quantity+(t.cats.length-1)*300*t.quantity)}),(t.state==="已取消"||t.state==="已退房")&&A.setAttribute("disabled",!0)}function Y(){z.classList.toggle("d-none"),F.classList.toggle("d-none"),A.classList.toggle("d-none"),O.classList.toggle("d-none")}function C(){x.toggleAttribute("disabled"),y.toggleAttribute("disabled"),I.toggleAttribute("disabled"),b.toggleAttribute("disabled"),d.toggleAttribute("disabled"),L.toggleAttribute("disabled"),_.toggleAttribute("disabled"),document.querySelectorAll(".form-check-input").forEach(function(t){t.toggleAttribute("disabled")})}function H(){g.fire({title:"日期格式錯誤?",text:"入住日期不可與退房日期相等, 或在其之後",icon:"error"})}function rt(){g.fire({icon:"warning",title:"系統提示",text:"資料有修改且尚未儲存, 確定取消修改資料嗎?"})}function R(t){let e=0;return t.forEach(function(a){a.checked&&e++}),e}function ut(){const t=document.querySelectorAll(".form-check-input");let e=R(t);return e<=0&&g.fire({icon:"error",title:"入住貓咪數量不能小於 1"}),R(t),e}function U(t,e){let a=0;document.querySelectorAll(".form-check-input").forEach(function(u){u.checked&&a++}),t.state=e,t.catNum=a,t.updateTime=S().format("YYYY-MM-DD hh-mm-ss a"),t.checkIn=y.value,t.checkOut=I.value,t.quantity=d.value,t.roomType=b.value,t.bookingsId=B.value,t.price=D.value,t.remark=L.value,t.admin=localStorage.getItem("userName")}function lt(){g.fire({icon:"error",title:"很抱歉",text:"您選擇的日期與房型目前已滿房"})}j.addEventListener("change",function(t){const e=S(y.value),u=S(I.value).diff(e,"days");t.target.classList.contains("bookingDays")&&(d.value<=0?H():I.value=S(y.value).add(d.value,"days").format("YYYY-MM-DD"),roomObj.forEach(function(n){n.name===b.value&&(D.value=n.price*d.value)})),t.target.classList.contains("checkIn")&&(I.value=S(y.value).add(d.value,"days").format("YYYY-MM-DD")),t.target.classList.contains("checkOut")&&(u<=0?H():d.value=u,roomObj.forEach(function(n){n.name===b.value&&(D.value=n.price*d.value)})),t.target.classList.contains("bookingRoomType")&&roomObj.forEach(function(n){n.name===b.value&&(D.value=n.price*d.value)}),ut()});document.querySelectorAll("a").forEach(function(t){t.addEventListener("click",function(e){const a={經典房:51,精緻房:52,豪華房:53};let u="";if(document.querySelectorAll(".form-check-input").forEach(function(n){n.checked&&(u+=n.dataset.catid)}),x.value!=="已取消"&&(bookingObj.checkIn!==y.value||bookingObj.checkOut!==I.value||bookingObj.state!==x.value||bookingObj.remark!==L.value||bookingObj.roomId!==a[b.value]||bookingObj.cats.join(",")!==u))return e.preventDefault(),rt()})});z.addEventListener("click",function(){location="admin_bookingList.html"});
