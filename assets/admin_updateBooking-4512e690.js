import{S}from"./sweetalert2.all-1988d671.js";import"./admin_header-58c6939d.js";import{a as m,_ as h}from"./config-4096d6dc.js";import{h as q}from"./moment-fbc5633a.js";import{h as p}from"./admin_config-2cf1d757.js";import{r as b}from"./loginIsTimeUp-72a7432e.js";const B=document.querySelector(".bookingId"),G=document.querySelector(".memberName"),Y=document.querySelector(".bookingState"),k=document.querySelector(".checkIn"),I=document.querySelector(".checkOut"),J=document.querySelector(".memberPhone"),y=document.querySelector(".bookingRoomType"),d=document.querySelector(".bookingDays"),K=document.querySelector(".checkInCats"),Q=document.querySelector(".plusCatPay"),T=document.querySelector(".totalPrice"),V=document.querySelector(".getCats"),A=document.querySelector(".remark"),W=document.querySelector(".tbody"),L=document.querySelector(".btnUpdate"),O=document.querySelector(".btnUpdateCancel"),F=document.querySelector(".btnSave"),_=document.querySelector(".btnCancel"),z=document.querySelector(".btnBack"),X=document.querySelector("form"),j=m.get(`${h}/660/bookings/${localStorage.getItem("bookingNum")}`,p),tt=m.get(`${h}/660/rooms/`,p),et=m.get(`${h}/660/roomstates/`,p),ot=m.get(`${h}/660/cats`,p),at=m.get(`${h}/660/users/${localStorage.getItem("bookingUserId")}`,p);Promise.all([j,tt,et,ot,at]).then(function(t){const e=t[0].data,r=t[1].data,u=t[2].data,c=t[3].data,n=t[4].data;C(e,r,n);let s=[];c.forEach(function(a){a.userId==e.userId&&s.push(a)});let l="";s.forEach(function(a,o){l+=`<div class="col-4">
                    <div class="form-check">
                        <input class="form-check-input" data-catid="${a.id}" type="checkbox" id="memberCat${o+1}">
                        <label class="form-check-label memberCat${o+1}" for="memberCat${o+1}">${a.catName}</label>
                    </div>
                </div>`,V.innerHTML=l}),D(),e.cats.forEach(function(a){document.querySelectorAll(".form-check-input").forEach(function(o){parseInt(o.dataset.catid)===a&&o.setAttribute("checked",!0)})}),F.addEventListener("click",function(){let a=[];u.forEach(function(i){a.push(i)});let o=[];N(o,a);const g={經典房:"classic",精緻房:"delicate",豪華房:"luxury"};let $=1;for(let i=1;i<=d.value;i++)a.forEach(function(v){v.date===q(k.value).add(i-1,"day").format("YYYY-MM-DD")&&($*=v.availableCount[g[y.value]])});if($>0){for(let f=1;f<=d.value;f++)a.forEach(function(E){E.date===q(k.value).add(f-1,"day").format("YYYY-MM-DD")&&(E.availableCount[g[y.value]]--,o.push(E))});o.forEach(function(f){m.patch(`${h}/660/roomStates/${f.id}`,f,{headers:{authorization:`Bearer ${localStorage.getItem("userLoginToken")}`}}).then(function(E){}).catch(function(E){b(E.response.data)})});const i={};U(i,Y.value),P(i);const v={經典房:51,精緻房:52,豪華房:53};e.checkIn=k.value,e.checkOut=I.value,e.remark=A.value,e.quantity=d.value,e.price=T.value,e.state=Y.value,e.roomId=v[y.value],e.admin.userId=localStorage.getItem("userId"),e.cats=[],document.querySelectorAll(".form-check-input").forEach(function(f){f.checked&&e.cats.push(parseInt(f.dataset.catid))}),M(e),C(e,r,n),x(),D()}else o=[],x(),ut(),C(e,r,n),D()}),_.addEventListener("click",function(){S.fire({title:"確定要取消此訂單嗎?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"確定取消",cancelButtonText:"返回訂單"}).then(a=>{a.isConfirmed&&m.patch(`${h}/660/bookings/${localStorage.getItem("bookingNum")}`,{state:"已取消"},p).then(function(o){const g={};U(g,"已取消"),C(e,r,n),x(),D();let $=[];N($,u),$.forEach(function(i){u.forEach(function(v){i.date===v.date&&m.patch(`${h}/660/roomStates/${i.id}`,i,p).then(function(f){P(g),S.mixin({toast:!0,position:"center",showConfirmButton:!1,timer:1200,timerProgressBar:!0,didOpen:H=>{H.onmouseenter=S.stopTimer,H.onmouseleave=S.resumeTimer}}).fire({icon:"success",title:"訂單已取消成功"})}).catch(function(f){b(f.response.data)})})})}).catch(function(o){b(o.response.data)})})});function N(a,o){let g=e.checkIn;const $={51:"classic",52:"delicate",53:"luxury"};for(let i=0;i<e.quantity;i++)o.forEach(function(v){v.date===q(g).add(0+i,"day").format("YYYY-MM-DD")&&(v.availableCount[$[e.roomId]]++,a.push(v))})}function M(a){m.patch(`${h}/660/bookings/${a.id}`,a,p).then(function(o){C(o.data,r,n)}).catch(function(o){b(o.response.data)})}function Z(a){m.get(`${h}/660/bookings/${a.bookingsId}`,p).then(function(o){const g=o.data;g.history.push(a.id),M(g)}).catch(function(o){b(o.response.data)})}function P(a){m.post(`${h}/660/bookingHistorys`,a,p).then(function(o){Z(o.data)}).catch(function(o){b(o.response.data)})}L.addEventListener("click",function(){x(),D()}),O.addEventListener("click",function(){x(),D(),C(e,r,n)})}).catch(function(t){b(t.response.data)});function ct(t){let e=[],r="";function u(n){return m.get(`${h}/660/bookingHistorys/${n}`,p).then(s=>{const l={};l.updateTime=s.data.updateTime,l.catNum=s.data.catNum,l.admin=s.data.admin,l.checkIn=s.data.checkIn,l.checkOut=s.data.checkOut,l.quantity=s.data.quantity,l.roomType=s.data.roomType,l.state=s.data.state,l.price=s.data.price,l.remark=s.data.remark,e.push(l)}).catch(s=>{console.error(s),b(s.response.data)})}const c=t.map(n=>u(n));return Promise.all(c).then(()=>{e.forEach(function(n){r+=`<tr>
                            <th class="text-nowrap p-1" scope="row">${n.updateTime}</th>
                            <td class="text-nowrap p-1">${n.state}</td>
                            <td class="text-nowrap p-1">${n.checkIn}</td>
                            <td class="text-nowrap p-1">${n.checkOut}</td>
                            <td class="text-nowrap p-1">${n.quantity}</td>
                            <td class="text-nowrap p-1">${n.roomType}</td>
                            <td class="text-nowrap p-1">${n.price}</td>
                            <td class="text-nowrap p-1">${n.catNum}</td>
                            <td class="text-nowrap p-1">${n.remark}</td>
                            <td class="text-nowrap p-1">${n.admin}</td>
                        </tr>`}),W.innerHTML=r})}function C(t,e,r){let u="";e.forEach(function(c){c.id===t.roomId&&(u=c.name)}),ct(t.history),B.value=localStorage.getItem("bookingNum"),G.value=r.name,Y.value=t.state,k.value=t.checkIn,I.value=t.checkOut,J.value=r.phone,y.value=u,d.value=t.quantity,A.value=t.remark,K.value=t.cats.length,Q.value=(t.cats.length-1)*300*t.quantity,e.forEach(function(c){c.id===t.roomId&&(T.value=c.price*t.quantity+(t.cats.length-1)*300*t.quantity)}),(t.state==="已取消"||t.state==="已退房")&&L.setAttribute("disabled",!0)}function x(){z.classList.toggle("d-none"),F.classList.toggle("d-none"),L.classList.toggle("d-none"),O.classList.toggle("d-none")}function D(){Y.toggleAttribute("disabled"),k.toggleAttribute("disabled"),I.toggleAttribute("disabled"),y.toggleAttribute("disabled"),d.toggleAttribute("disabled"),A.toggleAttribute("disabled"),_.toggleAttribute("disabled"),document.querySelectorAll(".form-check-input").forEach(function(t){t.toggleAttribute("disabled")})}function w(){S.fire({title:"日期格式錯誤?",text:"入住日期不可與退房日期相等, 或在其之後",icon:"error"})}function nt(){S.fire({icon:"warning",title:"系統提示",text:"資料有修改且尚未儲存, 確定取消修改資料嗎?"})}function R(t){let e=0;return t.forEach(function(r){r.checked&&e++}),e}function rt(){const t=document.querySelectorAll(".form-check-input");let e=R(t);return e<=0&&S.fire({icon:"error",title:"入住貓咪數量不能小於 1"}),R(t),e}function U(t,e){let r=0;document.querySelectorAll(".form-check-input").forEach(function(u){u.checked&&r++}),t.state=e,t.catNum=r,t.updateTime=q().format("YYYY-MM-DD hh-mm-ss a"),t.checkIn=k.value,t.checkOut=I.value,t.quantity=d.value,t.roomType=y.value,t.bookingsId=B.value,t.price=T.value,t.remark=A.value,t.admin=localStorage.getItem("userName")}function ut(){S.fire({icon:"error",title:"很抱歉",text:"您選擇的日期與房型目前已滿房"})}X.addEventListener("change",function(t){const e=q(k.value),u=q(I.value).diff(e,"days");t.target.classList.contains("bookingDays")&&(d.value<=0?w():I.value=q(k.value).add(d.value,"days").format("YYYY-MM-DD"),roomObj.forEach(function(c){c.name===y.value&&(T.value=c.price*d.value)})),t.target.classList.contains("checkIn")&&(I.value=q(k.value).add(d.value,"days").format("YYYY-MM-DD")),t.target.classList.contains("checkOut")&&(u<=0?w():d.value=u,roomObj.forEach(function(c){c.name===y.value&&(T.value=c.price*d.value)})),t.target.classList.contains("bookingRoomType")&&roomObj.forEach(function(c){c.name===y.value&&(T.value=c.price*d.value)}),rt()});document.querySelectorAll("a").forEach(function(t){t.addEventListener("click",function(e){const r={經典房:51,精緻房:52,豪華房:53};let u="";if(document.querySelectorAll(".form-check-input").forEach(function(c){c.checked&&(u+=c.dataset.catid)}),Y.value!=="已取消"&&(bookingObj.checkIn!==k.value||bookingObj.checkOut!==I.value||bookingObj.state!==Y.value||bookingObj.remark!==A.value||bookingObj.roomId!==r[y.value]||bookingObj.cats.join(",")!==u))return e.preventDefault(),nt()})});z.addEventListener("click",function(){location="admin_bookingList.html"});
